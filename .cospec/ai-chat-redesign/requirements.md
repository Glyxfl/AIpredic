# AI对话模块重写需求文档

## 1. 项目背景

### 1.1 背景描述

现有AI对话模块在代码审查中发现多处严重问题，需要进行系统性重构以确保功能正确性和用户体验。

### 1.2 问题清单

通过代码分析，现有模块存在以下问题：

1. **数据丢失Bug**：API未正确保存助手回复到数据库
2. **SSE消息序列化风险**：token未经转义可能破坏SSE格式
3. **状态同步问题**：客户端消息与服务器不同步导致闪烁
4. **渲染问题**：消息key不稳定可能导致渲染错误
5. **代码质量问题**：重复状态定义、硬编码等

---

## 2. 功能需求（必须修复）

### 2.1 数据持久化

#### FR-001: 助手消息保存

- **需求描述**: 确保AI助手的回复正确保存到数据库
- **优先级**: P0（高）
- **验收标准**: 
  - 助手回复内容在SSE流结束后100%入库
  - 数据库中消息记录与API响应内容一致
- **依赖关系**: 无

### 2.2 SSE消息传输

#### FR-002: Token转义处理

- **需求描述**: 对SSE消息中的特殊字符进行正确转义
- **优先级**: P0（高）
- **验收标准**:
  - `[data:]`、`:`等SSE保留字符正确转义
  - 消息体不破坏SSE格式解析
- **依赖关系**: 无

### 2.3 状态同步

#### FR-003: 消息状态一致性

- **需求描述**: 确保客户端显示的消息与服务器端一致
- **优先级**: P0（高）
- **验收标准**:
  - 消息发送后无闪烁现象
  - 消息ID在服务器端生成并返回客户端
- **依赖关系**: FR-001

### 2.4 渲染稳定性

#### FR-004: 消息组件Key稳定性

- **需求描述**: 为消息列表提供稳定的唯一标识符
- **优先级**: P1（中）
- **验收标准**:
  - 每条消息有唯一的、不可变的ID
  - 重渲染时消息顺序和位置不抖动
- **依赖关系**: FR-001

---

## 3. 非功能性需求（建议改进）

### 3.1 代码质量

#### NFR-001: 消除重复代码

- **需求描述**: 移除重复的状态定义和组件逻辑
- **优先级**: P2（低）
- **验收标准**: 
  - 无重复的状态定义（如`isTyping`）
  - 无重复的业务逻辑代码块

#### NFR-002: 移除硬编码

- **需求描述**: 将硬编码值提取为配置项
- **优先级**: P2（低）
- **验收标准**:
  - 无直接写在代码中的魔法数字
  - 配置项集中管理

### 3.2 可维护性

#### NFR-003: 类型定义优化

- **需求描述**: 统一和完善TypeScript类型定义
- **优先级**: P2（低）
- **验收标准**:
  - 消息类型定义完整且一致
  - API响应类型清晰可追溯

---

## 4. 用户故事

### US-001: 稳定的消息展示

**作为** 用户  
**我想要** 发送问题后看到稳定、不闪烁的消息显示  
**以便于** 获得流畅的对话体验

**验收条件**:

- [ ] 发送消息后立即显示在界面中
- [ ] 助手回复内容不会丢失或重复显示
- [ ] 消息列表滚动位置保持稳定

### US-002: 完整的对话历史

**作为** 用户  
**我想要** 刷新页面后仍能看到之前的对话内容  
**以便于** 回顾之前的交流历史

**验收条件**:

- [ ] 所有消息（包括助手回复）正确保存到数据库
- [ ] 页面刷新后消息历史完整显示
- [ ] 断线重连后消息不丢失

---

## 5. 假设和依赖

### 5.1 假设

- 数据库连接和ORM框架工作正常
- AI API（Claude/OpenAI/Moonshot/yi）接口稳定
- 用户认证系统已正常工作

### 5.2 依赖

- 无外部依赖阻塞

---

## 6. 范围定义

### 6.1 包含范围

- API层：chat消息处理逻辑
- 前端：消息展示和状态管理
- 数据持久化：消息保存逻辑

### 6.2 不包含范围

- 测试用例编写
- 部署配置和CI/CD流程
- 数据库结构优化
- 监控和日志系统设计