{"design":{"lastTaskId":"aa8c09fd-7d7b-47bf-a0d4-864d2eb42f31","lastCheckpointId":"b7a567ad70ca2b35005b52684b0ee70b08285f34","content":"# AI对话模块技术设计文档\r\n\r\n## 1. 架构概述\r\n\r\n### 1.1 目标\r\n\r\n- 确保AI助手回复正确持久化到数据库\r\n- 修复SSE消息传输中的特殊字符转义问题\r\n- 实现客户端与服务器消息状态同步，消除闪烁\r\n- 为消息列表提供稳定的唯一标识符\r\n\r\n### 1.2 架构原则\r\n\r\n- 乐观更新与服务器确认相结合\r\n- 消息ID由服务器统一生成\r\n- SSE消息体必须安全转义\r\n\r\n## 2. 系统架构\r\n\r\n### 2.1 整体架构图\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph 客户端\r\n        A[ChatWindow组件]\r\n        B[SSE Reader]\r\n        C[消息状态管理]\r\n        D[useTyping Hook]\r\n    end\r\n\r\n    subgraph API网关层\r\n        E[POST /api/chat]\r\n    end\r\n\r\n    subgraph 业务服务层\r\n        F[消息构建器]\r\n        G[AI流式响应器]\r\n        H[SSE编码器]\r\n    end\r\n\r\n    subgraph 数据层\r\n        I[Prisma ORM]\r\n        J[PostgreSQL]\r\n    end\r\n\r\n    A -->|1. 发送消息| E\r\n    E -->|2. 创建对话/追加消息| I\r\n    I --> J\r\n    E -->|3. 流式响应| G\r\n    G -->|4. Token事件| H\r\n    H -->|5. SSE格式| A\r\n    G -->|6. 保存助手消息| I\r\n```\r\n\r\n### 2.2 数据流设计\r\n\r\n```mermaid\r\nsequenceDiagram\r\n    participant Client as 客户端\r\n    participant API as /api/chat\r\n    participant DB as 数据库\r\n    participant AI as AI模型服务\r\n\r\n    Client->>API: POST /api/chat (chatId, model, message)\r\n    API->>DB: 创建/更新对话，保存用户消息\r\n    API->>AI: 发起流式请求\r\n\r\n    loop 流式响应\r\n        AI->>API: 逐token返回\r\n        API->>DB: 追加助手消息到数组\r\n        API->>Client: SSE: {\"id\":\"...\",\"token\":\"...\",\"done\":false}\r\n    end\r\n\r\n    AI->>API: 流结束\r\n    API->>DB: 保存完整助手消息\r\n    API->>Client: SSE: {\"done\":true,\"messages\":[...]}\r\n    Client->>Client: 更新消息列表\r\n```\r\n\r\n## 3. 服务设计\r\n\r\n### 3.1 API设计\r\n\r\n#### 3.1.1 POST /api/chat\r\n\r\n**描述**: 处理用户消息，触发AI流式响应\r\n\r\n**请求格式**:\r\n```json\r\n{\r\n  \"chatId\": \"string (optional)\",\r\n  \"model\": \"string\",\r\n  \"message\": \"string\"\r\n}\r\n```\r\n\r\n**响应格式** (SSE):\r\n```json\r\n{\"type\":\"message\",\"id\":\"...\",\"data\":{\"role\":\"assistant\",\"content\":\"...\"}}\r\n{\"type\":\"token\",\"token\":\"...\"}\r\n{\"type\":\"done\",\"messageId\":\"...\"}\r\n```\r\n\r\n#### 3.1.2 错误响应\r\n\r\n```json\r\n{\"type\":\"error\",\"message\":\"...\"}\r\n```\r\n\r\n### 3.2 SSE消息格式\r\n\r\n| 事件类型 | 用途 | 数据结构 |\r\n|---------|------|----------|\r\n| message | 单条消息元数据 | {id, role, content} |\r\n| token | 流式token | {token} |\r\n| done | 流结束信号 | {messageId, finalMessages} |\r\n| error | 错误信息 | {message} |\r\n\r\n### 3.3 消息状态流转\r\n\r\n```mermaid\r\nstateDiagram-v2\r\n    [*] --> 发送中: 用户提交消息\r\n    发送中 --> 本地用户消息: 添加用户消息\r\n    本地用户消息 --> 流式接收: 建立SSE连接\r\n    流式接收 --> 打字效果: 收到token\r\n    打字效果 --> 流式接收: 继续接收\r\n    流式接收 --> 消息完成: 收到done事件\r\n    消息完成 --> [*]\r\n    \r\n    流式接收 --> 错误状态: 发生错误\r\n    错误状态 --> [*]\r\n```\r\n\r\n## 4. 数据架构\r\n\r\n### 4.1 消息结构\r\n\r\n```typescript\r\ninterface Message {\r\n  id: string           // 服务器生成的唯一ID\r\n  role: 'user' | 'assistant' | 'system'\r\n  content: string\r\n  createdAt: string\r\n}\r\n\r\ninterface Chat {\r\n  id: string\r\n  title: string\r\n  model: string\r\n  messages: Message[]\r\n  createdAt: string\r\n  updatedAt: string\r\n}\r\n```\r\n\r\n### 4.2 消息保存策略\r\n\r\n1. 用户消息: 发送前保存到数据库\r\n2. 助手消息: 流结束后保存完整消息\r\n3. 增量更新: 流式接收时在内存中累积\r\n\r\n## 5. 组件设计\r\n\r\n### 5.1 组件职责划分\r\n\r\n| 组件 | 职责 |\r\n|-----|------|\r\n| ChatWindow | 消息列表展示、表单提交、SSE连接管理 |\r\n| MessageBubble | 单条消息渲染 |\r\n| useTyping | 流式打字效果状态管理 |\r\n\r\n### 5.2 状态管理方案\r\n\r\n```typescript\r\ninterface ChatState {\r\n  messages: Message[]\r\n  isLoading: boolean\r\n  input: string\r\n  currentChatId: string | null\r\n  currentModel: string\r\n}\r\n```\r\n\r\n### 5.3 Key稳定性策略\r\n\r\n- 消息ID作为组件key\r\n- ID由服务器端生成，确保全局唯一和不可变\r\n- 避免使用内容相关的临时ID\r\n\r\n## 6. 关键技术决策\r\n\r\n### 6.1 Token转义方案\r\n\r\n**方案**: 使用JSON.stringify对token进行转义\r\n\r\n```typescript\r\n// 转义函数\r\nfunction escapeSSE(token: string): string {\r\n  return JSON.stringify(token).slice(1, -1)\r\n}\r\n\r\n// 使用\r\nconst sseData = `data: {\"token\": \"${escapeSSE(token)}\"}\\n\\n`\r\n```\r\n\r\n**优点**: 简单可靠，覆盖所有需要转义的字符\r\n\r\n### 6.2 消息保存时机\r\n\r\n**方案**: 流结束后统一保存\r\n\r\n- 流开始时不保存助手消息\r\n- 流结束时构建完整消息数组，一次性保存\r\n- 确保数据一致性\r\n\r\n### 6.3 状态同步机制\r\n\r\n**方案**: SSE事件携带消息ID\r\n\r\n1. 客户端乐观添加用户消息（临时ID）\r\n2. 服务器创建消息返回正式ID\r\n3. 客户端用正式ID替换临时ID\r\n\r\n## 7. 文件修改清单\r\n\r\n| 文件 | 修改内容 |\r\n|-----|----------|\r\n| src/app/api/chat/route.ts | FR-001, FR-002 |\r\n| src/modules/chat/ChatWindow.tsx | FR-003, FR-004 |\r\n| src/modules/chat/MessageBubble.tsx | 接收消息ID |\r\n| src/modules/chat/types.ts | 更新Message类型 |\r\n| src/lib/constants.ts | 新增SSE配置常量 |\r\n\r\n## 8. 风险与约束\r\n\r\n### 8.1 风险点\r\n\r\n- AI API响应超时可能导致消息不完整\r\n- 网络中断需要重试机制\r\n\r\n### 8.2 约束\r\n\r\n- 不修改数据库表结构\r\n- 保持向后兼容\r\n- 不增加新的外部依赖"},"requirements":{"lastTaskId":"91938162-e02b-41ba-b3bc-3ab44f58d3fa","lastCheckpointId":"4986fa3d242ff4521d143edfc629e7d6565d4ed0","content":"# AI对话模块重写需求文档\r\n\r\n## 1. 项目背景\r\n\r\n### 1.1 背景描述\r\n\r\n现有AI对话模块在代码审查中发现多处严重问题，需要进行系统性重构以确保功能正确性和用户体验。\r\n\r\n### 1.2 问题清单\r\n\r\n通过代码分析，现有模块存在以下问题：\r\n\r\n1. **数据丢失Bug**：API未正确保存助手回复到数据库\r\n2. **SSE消息序列化风险**：token未经转义可能破坏SSE格式\r\n3. **状态同步问题**：客户端消息与服务器不同步导致闪烁\r\n4. **渲染问题**：消息key不稳定可能导致渲染错误\r\n5. **代码质量问题**：重复状态定义、硬编码等\r\n\r\n---\r\n\r\n## 2. 功能需求（必须修复）\r\n\r\n### 2.1 数据持久化\r\n\r\n#### FR-001: 助手消息保存\r\n\r\n- **需求描述**: 确保AI助手的回复正确保存到数据库\r\n- **优先级**: P0（高）\r\n- **验收标准**: \r\n  - 助手回复内容在SSE流结束后100%入库\r\n  - 数据库中消息记录与API响应内容一致\r\n- **依赖关系**: 无\r\n\r\n### 2.2 SSE消息传输\r\n\r\n#### FR-002: Token转义处理\r\n\r\n- **需求描述**: 对SSE消息中的特殊字符进行正确转义\r\n- **优先级**: P0（高）\r\n- **验收标准**:\r\n  - `[data:]`、`:`等SSE保留字符正确转义\r\n  - 消息体不破坏SSE格式解析\r\n- **依赖关系**: 无\r\n\r\n### 2.3 状态同步\r\n\r\n#### FR-003: 消息状态一致性\r\n\r\n- **需求描述**: 确保客户端显示的消息与服务器端一致\r\n- **优先级**: P0（高）\r\n- **验收标准**:\r\n  - 消息发送后无闪烁现象\r\n  - 消息ID在服务器端生成并返回客户端\r\n- **依赖关系**: FR-001\r\n\r\n### 2.4 渲染稳定性\r\n\r\n#### FR-004: 消息组件Key稳定性\r\n\r\n- **需求描述**: 为消息列表提供稳定的唯一标识符\r\n- **优先级**: P1（中）\r\n- **验收标准**:\r\n  - 每条消息有唯一的、不可变的ID\r\n  - 重渲染时消息顺序和位置不抖动\r\n- **依赖关系**: FR-001\r\n\r\n---\r\n\r\n## 3. 非功能性需求（建议改进）\r\n\r\n### 3.1 代码质量\r\n\r\n#### NFR-001: 消除重复代码\r\n\r\n- **需求描述**: 移除重复的状态定义和组件逻辑\r\n- **优先级**: P2（低）\r\n- **验收标准**: \r\n  - 无重复的状态定义（如`isTyping`）\r\n  - 无重复的业务逻辑代码块\r\n\r\n#### NFR-002: 移除硬编码\r\n\r\n- **需求描述**: 将硬编码值提取为配置项\r\n- **优先级**: P2（低）\r\n- **验收标准**:\r\n  - 无直接写在代码中的魔法数字\r\n  - 配置项集中管理\r\n\r\n### 3.2 可维护性\r\n\r\n#### NFR-003: 类型定义优化\r\n\r\n- **需求描述**: 统一和完善TypeScript类型定义\r\n- **优先级**: P2（低）\r\n- **验收标准**:\r\n  - 消息类型定义完整且一致\r\n  - API响应类型清晰可追溯\r\n\r\n---\r\n\r\n## 4. 用户故事\r\n\r\n### US-001: 稳定的消息展示\r\n\r\n**作为** 用户  \r\n**我想要** 发送问题后看到稳定、不闪烁的消息显示  \r\n**以便于** 获得流畅的对话体验\r\n\r\n**验收条件**:\r\n\r\n- [ ] 发送消息后立即显示在界面中\r\n- [ ] 助手回复内容不会丢失或重复显示\r\n- [ ] 消息列表滚动位置保持稳定\r\n\r\n### US-002: 完整的对话历史\r\n\r\n**作为** 用户  \r\n**我想要** 刷新页面后仍能看到之前的对话内容  \r\n**以便于** 回顾之前的交流历史\r\n\r\n**验收条件**:\r\n\r\n- [ ] 所有消息（包括助手回复）正确保存到数据库\r\n- [ ] 页面刷新后消息历史完整显示\r\n- [ ] 断线重连后消息不丢失\r\n\r\n---\r\n\r\n## 5. 假设和依赖\r\n\r\n### 5.1 假设\r\n\r\n- 数据库连接和ORM框架工作正常\r\n- AI API（Claude/OpenAI/Moonshot/yi）接口稳定\r\n- 用户认证系统已正常工作\r\n\r\n### 5.2 依赖\r\n\r\n- 无外部依赖阻塞\r\n\r\n---\r\n\r\n## 6. 范围定义\r\n\r\n### 6.1 包含范围\r\n\r\n- API层：chat消息处理逻辑\r\n- 前端：消息展示和状态管理\r\n- 数据持久化：消息保存逻辑\r\n\r\n### 6.2 不包含范围\r\n\r\n- 测试用例编写\r\n- 部署配置和CI/CD流程\r\n- 数据库结构优化\r\n- 监控和日志系统设计"},"tasks":{"lastTaskId":"1d880ede-8db3-4c11-96b8-f14381cd8363","lastCheckpointId":"7a75263af02342bab6aadc70a48da309991df56f","content":"# AI对话模块重写任务清单\r\n\r\n- [ ] 1. 创建SSE配置常量\r\n  - 在constants.ts中新增SSE_TOKEN_ESCAPE_REGEX和SSE_LINE_END常量\r\n  - 提供统一的转义正则和行结束符配置\r\n  - _需求：[FR-002]_\r\n  - _测试：[token转义功能可测试]\r\n\r\n- [ ] 2. 更新Message类型定义\r\n  - 在types.ts中为Message接口添加id字段\r\n  - 确保类型定义与API响应格式一致\r\n  - _需求：[FR-003], [FR-004]_\r\n\r\n- [ ] 3. 实现Token转义功能\r\n  - 在chat/route.ts中创建escapeToken函数\r\n  - 使用JSON.stringify对特殊字符进行转义\r\n  - 在token事件发送前应用转义\r\n  - _需求：[FR-002]_\r\n  - _测试：[SSE格式解析正常]\r\n\r\n- [ ] 4. 实现消息保存逻辑\r\n  - 修改chat/route.ts中的消息处理流程\r\n  - 在SSE流结束后将完整助手消息保存到数据库\r\n  - 确保用户消息在发送前入库\r\n  - _需求：[FR-001]_\r\n  - _测试：[助手消息完整入库]\r\n\r\n- [ ] 5. 实现SSE消息ID返回\r\n  - 在chat/route.ts的done事件中返回messageId\r\n  - 在message事件中返回消息元数据包含id\r\n  - 确保客户端能获取服务器生成的消息ID\r\n  - _需求：[FR-003], [FR-004]_\r\n  - _测试：[消息ID正确同步]\r\n\r\n- [ ] 6. 更新ChatWindow状态管理\r\n  - 修改ChatWindow.tsx添加消息ID状态\r\n  - 实现SSE事件处理：解析message事件更新消息ID\r\n  - 使用服务器消息ID替代临时ID\r\n  - 移除重复的isTyping状态定义\r\n  - _需求：[FR-003], [FR-004], [NFR-001]_\r\n  - _测试：[消息状态一致]\r\n\r\n- [ ] 7. 更新MessageBubble组件\r\n  - 修改MessageBubble.tsx接收并使用消息ID作为key\r\n  - 确保消息渲染稳定性\r\n  - _需求：[FR-004]_\r\n  - _测试：[重渲染时消息不抖动]"},"version":"1.0.0","lastModified":"2026-01-06T03:06:13.839Z"}